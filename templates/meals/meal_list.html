{% extends 'base.html' %}
{% load static %}
{% load nutrition_extras %} {# <-- Load your custom filter library #}
{% block additional_style %}
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<style>
    /* General Body Styling */
    body {
        background-color: #f8f9fa;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 0;
    }

    .page-header h1 {
        font-size: 2.75rem;
        color: #000;
        margin: 0;
    }

    .page-header p {
        font-size: 1.25rem;
        color: #000;
        margin: 5px 0 0;
    }

    /* Main Container Styling */
    .main-container {
        background-color: #fff;
        padding: 20px 30px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        margin: 20px auto;
        max-width: 1200px;
    }

    /* Section Headings */
    .section-heading {
        margin-top: 30px;
        margin-bottom: 15px;
        font-size: 1.75rem;
        color: #333;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 5px;
    }

    /* Card Styling */
    .meal-card {
        margin-bottom: 20px;
        border: none;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .meal-image {
        height: 150px;
        object-fit: cover;
    }

    .card-body ul {
        padding-left: 0;
        list-style: none;
    }

    /* Sidebar Styling */
    .sidebar {
        background-color: #fff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    /* Slider Styling */
    #priceRange {
        margin-top: 10px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    /* Basic Nutrition Facts Style */
    .nutrition-facts {
        
        width: 465px;
        border: 2px solid #000;
        padding: 10px;
        font-family: Arial, sans-serif;
        color: #000;
        background-color: #fff;
    }
    .nutrition-facts h2 {
        font-size: 1.2rem;
        margin-bottom: 0.5rem;
    }
    .nutrition-facts hr {
        border: 0;
        border-top: 2px solid #000;
        margin: 0.5rem 0;
    }
    .nutrition-facts p {
        margin: 0.2rem 0;
        font-size: 0.9rem;
    }
    .nutrition-facts strong {
        font-weight: bold;
    }
    .nutrition-facts .sub-item {
        margin-left: 1.5em;
    }

    /* Right-align the percentages */
    .dv-percentage {
        float: right;
    }
</style>
{% endblock additional_style %}

{% block content %}
    <!-- Main Content Container -->
    <div class="container main-container">
        <div class="row">
            <!-- Left Sidebar: Filter Form -->
            <div class="col-md-3">
                <div class="sidebar">
                    <!-- Collapsible Filter Panel -->
                    <div id="filterPanel">
                        <div class="card card-body">
                            <h5>Filter Options</h5>
                            <form method="get" action="">
                                <!-- Dietary Restrictions Filter using Checkboxes -->
                                <div class="form-group">
                                    <label>Dietary Restrictions</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="dietary" id="dietaryDairy"
                                               value="dairy">
                                        <label class="form-check-label" for="dietaryDairy">Dairy</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="dietary"
                                               id="dietaryGluten"
                                               value="gluten">
                                        <label class="form-check-label" for="dietaryGluten">Gluten</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="dietary"
                                               id="dietaryShellfish"
                                               value="shellfish">
                                        <label class="form-check-label" for="dietaryShellfish">Shellfish</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="dietary" id="dietaryEggs"
                                               value="eggs">
                                        <label class="form-check-label" for="dietaryEggs">Eggs</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="dietary"
                                               id="dietaryPeanuts"
                                               value="peanuts">
                                        <label class="form-check-label" for="dietaryPeanuts">Peanuts</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="dietary"
                                               id="dietaryTreeNuts"
                                               value="tree nuts">
                                        <label class="form-check-label" for="dietaryTreeNuts">Tree Nuts</label>
                                    </div>
                                </div>
                                <!-- Meal Diet Type Filter (Dropdown) -->
                                <div class="form-group">
                                    <label for="dietTypeFilter">Meal Diet Type</label>
                                    <select class="form-control" id="dietTypeFilter" name="diet_type">
                                        <option value="">Select Meal Diet Type</option>
                                        <option value="non-veg">Non-Vegetarian</option>
                                        <option value="veg">Vegetarian</option>
                                        <option value="vegan">Vegan</option>
                                    </select>
                                </div>
                                <!-- Price Range Filter using jQuery UI Slider -->
                                <div class="form-group">
                                    <label for="priceRange">Price Range: <span id="priceRangeValue"></span></label>
                                    <div id="priceRange"></div>
                                    <input type="hidden" id="priceRangeMin" name="price_min" value="0">
                                    <input type="hidden" id="priceRangeMax" name="price_max" value="50">
                                </div>
                                <!-- Cooking Duration Filter (Dropdown) -->
                                <div class="form-group">
                                    <label for="durationFilter">Cooking Duration Option</label>
                                    <select class="form-control" id="durationFilter" name="duration">
                                        <option value="">Select Duration</option>
                                        <option value="under15">Under 15 minutes</option>
                                        <option value="15to30">15-30 minutes</option>
                                        <option value="above30">Over 30 minutes</option>
                                    </select>
                                </div>
                                <div>
                                    <button type="submit" class="btn btn-primary btn-block">Apply Filter</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Meals Content Grouped by Meal Type -->
            <div class="col-md-9">
                <!-- Breakfast Items Section -->
                <h2 class="section-heading">Breakfast Items</h2>
                <div class="row">
                    {% for meal in meals %}
                        {% if meal.meal_type|lower == "breakfast" %}
                            <div class="col-md-6">
                                <div class="card meal-card">
                                    {% if meal.image %}
                                        <img class="card-img-top meal-image" src="{{ meal.image.url }}"
                                             alt="{{ meal.meal_name }}">
                                    {% else %}
                                        <img class="card-img-top meal-image" src="{% static 'meals/default.jpg' %}"
                                             alt="Default Image">
                                    {% endif %}
                                    <div class="card-body">
                                        <h5 class="card-title">{{ meal.meal_name }}</h5>
                                        <p class="card-text">{{ meal.recipe_description|truncatewords:20 }}</p>
                                        <ul class="list-unstyled">
                                            <li><strong>Ingredients:</strong> {{ meal.ingredients }}</li>
                                            <li><strong>Cost:</strong> ${{ meal.cost }}</li>
                                            <li><strong>Cooking Duration:</strong> {{ meal.cooking_duration }} min</li>
                                            <li><strong>Diet Type:</strong> {{ meal.get_diet_type_display }}</li>
                                            <li><strong>Total Calories:</strong> {{ meal.total_calories|floatformat:0 }}
                                                kcal
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="card-footer d-flex justify-content-between align-items-center">
                                        <button type="button" class="btn btn-primary" data-toggle="modal"
                                                data-target="#recipeModal{{ meal.id }}">
                                            View Recipe
                                        </button>
                                        <button type="button" class="btn btn-secondary" data-toggle="modal"
                                                data-target="#micronutrientsModal{{ meal.id }}">
                                            Micronutrients
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>

                <!-- Lunch Items Section -->
                <h2 class="section-heading">Lunch Items</h2>
                <div class="row">
                    {% for meal in meals %}
                        {% if meal.meal_type|lower == "lunch" %}
                            <div class="col-md-6">
                                <div class="card meal-card">
                                    {% if meal.image %}
                                        <img class="card-img-top meal-image" src="{{ meal.image.url }}"
                                             alt="{{ meal.meal_name }}">
                                    {% else %}
                                        <img class="card-img-top meal-image" src="{% static 'meals/default.jpg' %}"
                                             alt="Default Image">
                                    {% endif %}
                                    <div class="card-body">
                                        <h5 class="card-title">{{ meal.meal_name }}</h5>
                                        <p class="card-text">{{ meal.recipe_description|truncatewords:20 }}</p>
                                        <ul class="list-unstyled">
                                            <li><strong>Ingredients:</strong> {{ meal.ingredients }}</li>
                                            <li><strong>Cost:</strong> ${{ meal.cost }}</li>
                                            <li><strong>Cooking Duration:</strong> {{ meal.cooking_duration }} min</li>
                                            <li><strong>Diet Type:</strong> {{ meal.get_diet_type_display }}</li>
                                            <li><strong>Total Calories:</strong> {{ meal.total_calories|floatformat:0 }}
                                                kcal
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="card-footer d-flex justify-content-between align-items-center">
                                        <button type="button" class="btn btn-primary" data-toggle="modal"
                                                data-target="#recipeModal{{ meal.id }}">
                                            View Recipe
                                        </button>
                                        <button type="button" class="btn btn-secondary" data-toggle="modal"
                                                data-target="#micronutrientsModal{{ meal.id }}">
                                            Micronutrients
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>

                <!-- Dinner Items Section -->
                <h2 class="section-heading">Dinner Items</h2>
                <div class="row">
                    {% for meal in meals %}
                        {% if meal.meal_type|lower == "dinner" %}
                            <div class="col-md-6">
                                <div class="card meal-card">
                                    {% if meal.image %}
                                        <img class="card-img-top meal-image" src="{{ meal.image.url }}"
                                             alt="{{ meal.meal_name }}">
                                    {% else %}
                                        <img class="card-img-top meal-image" src="{% static 'meals/default.jpg' %}"
                                             alt="Default Image">
                                    {% endif %}
                                    <div class="card-body">
                                        <h5 class="card-title">{{ meal.meal_name }}</h5>
                                        <p class="card-text">{{ meal.recipe_description|truncatewords:20 }}</p>
                                        <ul class="list-unstyled">
                                            <li><strong>Ingredients:</strong> {{ meal.ingredients }}</li>
                                            <li><strong>Cost:</strong> ${{ meal.cost }}</li>
                                            <li><strong>Cooking Duration:</strong> {{ meal.cooking_duration }} min</li>
                                            <li><strong>Diet Type:</strong> {{ meal.get_diet_type_display }}</li>
                                            <li><strong>Total Calories:</strong> {{ meal.total_calories|floatformat:0 }}
                                                kcal
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="card-footer d-flex justify-content-between align-items-center">
                                        <button type="button" class="btn btn-primary" data-toggle="modal"
                                                data-target="#recipeModal{{ meal.id }}">
                                            View Recipe
                                        </button>
                                        <button type="button" class="btn btn-secondary" data-toggle="modal"
                                                data-target="#micronutrientsModal{{ meal.id }}">
                                            Micronutrients
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>

                <!-- Snack Items Section -->
                <h2 class="section-heading">Snack Items</h2>
                <div class="row">
                    {% for meal in meals %}
                        {% if meal.meal_type|lower == "snack" or meal.meal_type|lower == "snacks" %}
                            <div class="col-md-6">
                                <div class="card meal-card">
                                    {% if meal.image %}
                                        <img class="card-img-top meal-image" src="{{ meal.image.url }}"
                                             alt="{{ meal.meal_name }}">
                                    {% else %}
                                        <img class="card-img-top meal-image" src="{% static 'meals/default.jpg' %}"
                                             alt="Default Image">
                                    {% endif %}
                                    <div class="card-body">
                                        <h5 class="card-title">{{ meal.meal_name }}</h5>
                                        <p class="card-text">{{ meal.recipe_description|truncatewords:20 }}</p>
                                        <ul class="list-unstyled">
                                            <li><strong>Ingredients:</strong> {{ meal.ingredients }}</li>
                                            <li><strong>Cost:</strong> ${{ meal.cost }}</li>
                                            <li><strong>Cooking Duration:</strong> {{ meal.cooking_duration }} min</li>
                                            <li><strong>Diet Type:</strong> {{ meal.get_diet_type_display }}</li>
                                            <li><strong>Total Calories:</strong> {{ meal.total_calories|floatformat:0 }}
                                                kcal
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="card-footer d-flex justify-content-between align-items-center">
                                        <button type="button" class="btn btn-primary" data-toggle="modal"
                                                data-target="#recipeModal{{ meal.id }}">
                                            View Recipe
                                        </button>
                                        <button type="button" class="btn btn-secondary" data-toggle="modal"
                                                data-target="#micronutrientsModal{{ meal.id }}">
                                            Micronutrients
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recipe Modals for Each Meal -->
    {% for meal in meals %}
        <div class="modal fade" id="recipeModal{{ meal.id }}" tabindex="-1" role="dialog"
             aria-labelledby="recipeModalLabel{{ meal.id }}" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <!-- Modal Header without the 'X' button -->
                    <div class="modal-header">
                        <h5 class="modal-title" id="recipeModalLabel{{ meal.id }}">
                            {{ meal.meal_name }} Recipe
                        </h5>
                    </div>
                    <div class="modal-body">
                        <p><strong>Cooking Instructions:</strong></p>
                        <p>{{ meal.cooking_instructions }}</p>
                    </div>
                    <div class="modal-footer">
                        <!-- Only the Close button -->
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Micronutrients (Nutrition Facts) Modal for Each Meal -->
        <div class="modal fade" id="micronutrientsModal{{ meal.id }}" tabindex="-1" role="dialog"
             aria-labelledby="micronutrientsModalLabel{{ meal.id }}" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <!-- Modal Header without the 'X' button -->
                    <div class="modal-header">
                        <h5 class="modal-title" id="micronutrientsModalLabel{{ meal.id }}">
                            Micronutrients for {{ meal.meal_name }}
                        </h5>
                    </div>
                    <div class="modal-body">
                        <div class="nutrition-facts">
                            <h2>Nutrition Facts</h2>
                            <hr>
                            <p>
                                <strong>Serving Size:</strong> 1 meal
                                <span class="dv-percentage"><strong>% Daily Value</strong></span>
                            </p>
                            <hr>
                            <!-- Calories -->
                            <p>
                                <strong>Calories:</strong> {{ meal.total_calories|floatformat:0 }}
                                {% if recommended and recommended.calories %}
                                  <span class="dv-percentage">
                                    {{ meal.total_calories|nutrient_percent:recommended.calories|floatformat:0 }}%
                                  </span>
                                {% endif %}
                            </p>
                            <hr>
                            <!-- Fat with sub-classes -->
                            <p>
                                <strong>Total Fat:</strong> {{ meal.total_fat|floatformat:1 }} g
                                {% if recommended and recommended.total_fat %}
                                  <span class="dv-percentage">
                                    {{ meal.total_fat|nutrient_percent:recommended.total_fat|floatformat:0 }}%
                                  </span>
                                {% endif %}
                            </p>
                            <p class="sub-item">
                                Saturated Fat: {{ meal.total_saturated_fat|floatformat:1 }} g
                                {% if recommended and recommended.saturated_fat %}
                                  <span class="dv-percentage">
                                    {{ meal.total_saturated_fat|nutrient_percent:recommended.saturated_fat|floatformat:0 }}%
                                  </span>
                                {% endif %}
                            </p>
                            <p class="sub-item">
                                Trans Fat: {{ meal.total_trans_fat|floatformat:1 }} g
                                {% if recommended and recommended.trans_fat %}
                                  <span class="dv-percentage">
                                    {{ meal.total_trans_fat|nutrient_percent:recommended.trans_fat|floatformat:0 }}%
                                  </span>
                                {% endif %}
                            </p>

                            <p>
                                <strong>Cholesterol:</strong> {{ meal.total_cholesterol|floatformat:1 }} mg
                                {% if recommended and recommended.cholesterol %}
                                  <span class="dv-percentage">
                                    {{ meal.total_cholesterol|nutrient_percent:recommended.cholesterol|floatformat:0 }}%
                                  </span>
                                {% endif %}
                            </p>
                            <p>
                                <strong>Sodium:</strong> {{ meal.total_sodium|floatformat:1 }} mg
                                {% if recommended and recommended.sodium %}
                                  <span class="dv-percentage">
                                    {{ meal.total_sodium|nutrient_percent:recommended.sodium|floatformat:0 }}%
                                  </span>
                                {% endif %}
                            </p>
                            <p>
                                <strong>Potassium:</strong> {{ meal.total_potassium|floatformat:1 }} mg
                                {% if recommended and recommended.potassium %}
                                  <span class="dv-percentage">
                                    {{ meal.total_potassium|nutrient_percent:recommended.potassium|floatformat:0 }}%
                                  </span>
                                {% endif %}
                            </p>

                            <!-- Carbs with sub-classes -->
                            <p>
                                <strong>Total Carbohydrates:</strong> {{ meal.total_carbohydrates|floatformat:1 }} g
                                {% if recommended and recommended.carbohydrates %}
                                  <span class="dv-percentage">
                                    {{ meal.total_carbohydrates|nutrient_percent:recommended.carbohydrates|floatformat:0 }}%
                                  </span>
                                {% endif %}
                            </p>
                            <p class="sub-item">
                                Dietary Fiber: {{ meal.total_fiber|floatformat:1 }} g
                                {% if recommended and recommended.fiber %}
                                  <span class="dv-percentage">
                                    {{ meal.total_fiber|nutrient_percent:recommended.fiber|floatformat:0 }}%
                                  </span>
                                {% endif %}
                            </p>
                            <p class="sub-item">
                                Sugars: {{ meal.total_sugars|floatformat:1 }} g
                                {% if recommended and recommended.sugars %}
                                  <span class="dv-percentage">
                                    {{ meal.total_sugars|nutrient_percent:recommended.sugars|floatformat:0 }}%
                                  </span>
                                {% endif %}
                            </p>

                            <p>
                                <strong>Protein:</strong> {{ meal.total_protein|floatformat:1 }} g
                                {% if recommended and recommended.protein %}
                                  <span class="dv-percentage">
                                    {{ meal.total_protein|nutrient_percent:recommended.protein|floatformat:0 }}%
                                  </span>
                                {% endif %}
                            </p>
                            <hr>
                            <!-- Vitamins and Minerals -->
                            <p>
                                <strong>Vitamin A:</strong> {{ meal.total_vitamin_A|floatformat:1 }} IU
                                {% if recommended and recommended.vitamin_a %}
                                  <span class="dv-percentage">
                                    {{ meal.total_vitamin_A|nutrient_percent:recommended.vitamin_a|floatformat:0 }}%
                                  </span>
                                {% endif %}
                            </p>
                            <p>
                                <strong>Vitamin C:</strong> {{ meal.total_vitamin_C|floatformat:1 }} mg
                                {% if recommended and recommended.vitamin_c %}
                                  <span class="dv-percentage">
                                    {{ meal.total_vitamin_C|nutrient_percent:recommended.vitamin_c|floatformat:0 }}%
                                  </span>
                                {% endif %}
                            </p>
                            <p>
                                <strong>Vitamin B:</strong> {{ meal.total_vitamin_B|floatformat:1 }} mg
                                {% if recommended and recommended.vitamin_b %}
                                  <span class="dv-percentage">
                                    {{ meal.total_vitamin_B|nutrient_percent:recommended.vitamin_b|floatformat:0 }}%
                                  </span>
                                {% endif %}
                            </p>
                            <p>
                                <strong>Vitamin D:</strong> {{ meal.total_vitamin_D|floatformat:1 }} IU
                                {% if recommended and recommended.vitamin_d %}
                                  <span class="dv-percentage">
                                    {{ meal.total_vitamin_D|nutrient_percent:recommended.vitamin_d|floatformat:0 }}%
                                  </span>
                                {% endif %}
                            </p>
                            <hr>
                            <p>
                                <strong>Calcium:</strong> {{ meal.total_calcium|floatformat:1 }} mg
                                {% if recommended and recommended.calcium %}
                                  <span class="dv-percentage">
                                    {{ meal.total_calcium|nutrient_percent:recommended.calcium|floatformat:0 }}%
                                  </span>
                                {% endif %}
                            </p>
                            <p>
                                <strong>Zinc:</strong> {{ meal.total_zinc|floatformat:1 }} mg
                                {% if recommended and recommended.zinc %}
                                  <span class="dv-percentage">
                                    {{ meal.total_zinc|nutrient_percent:recommended.zinc|floatformat:0 }}%
                                  </span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <!-- Only the Close button -->
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}

    <!-- jQuery and jQuery UI (for the slider) -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <!-- Bootstrap JavaScript dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script>
        $(function () {
            $("#priceRange").slider({
                range: true,
                min: 0,
                max: 100,
                values: [0, 50],
                slide: function (event, ui) {
                    $("#priceRangeValue").text("$" + ui.values[0] + " - $" + ui.values[1]);
                    $("#priceRangeMin").val(ui.values[0]);
                    $("#priceRangeMax").val(ui.values[1]);
                }
            });
            var initialValues = $("#priceRange").slider("values");
            $("#priceRangeValue").text("$" + initialValues[0] + " - $" + initialValues[1]);
        });
    </script>
{% endblock content %}
